<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ORBIT SUM ‚Äî a fresh numbers game</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#0b1020" />

<style>
  /* =========================================================
     ORBIT SUM ‚Äî (c) 2025 Carlos' custom build, created by ChatGPT
     One-file, mobile-first, GitHub Pages‚Äìready.
     ========================================================= */

  :root{
    --bg: #0b1020;
    --bg2:#0f1530;
    --fg: #eaf2ff;
    --muted:#9fb2d6;
    --ring: rgba(255,255,255,0.08);
    --tile: #1a223b;
    --tileEdge: rgba(255,255,255,0.15);
    --accent: #44f0ff;
    --accent2:#8aff82;
    --danger:#ff5c7a;
    --gold:#ffd86b;
    --shadow: 0 10px 25px rgba(0,0,0,0.35);
    --glow: 0 0 20px rgba(68,240,255,.35), 0 0 1px rgba(68,240,255,.9) inset;
    --gateGlow: 0 0 24px rgba(255,216,107,.55), 0 0 1px rgba(255,216,107,.95) inset;
    --radiusRatio: .38; /* % of board min dimension */
  }

  @media (prefers-color-scheme: light){
    :root{ --bg:#f4f7ff; --bg2:#e7ecff; --fg:#0b1020; --muted:#3b4a6e; --ring: rgba(0,0,0,0.07); --tile:#eaf0ff; --tileEdge: rgba(0,0,0,0.1); }
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100%; margin:0; background: radial-gradient(1200px 800px at 50% -10%, var(--bg2), var(--bg)); color:var(--fg); font: 500 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; }
  #app{ max-width: 820px; margin: 0 auto; padding: env(safe-area-inset-top) 12px calc(14px + env(safe-area-inset-bottom));
        min-height:100%; display:flex; flex-direction:column; gap:8px; }

  /* Top bar */
  .topbar{ display:flex; align-items:center; justify-content:space-between; padding:8px 6px; }
  .brand{ font-weight:800; letter-spacing:1px; font-size:18px; display:flex; align-items:center; gap:8px; }
  .brand:before{ content:"‚óé"; color:var(--accent); text-shadow:0 0 10px rgba(68,240,255,.6); }
  .top-controls button{ background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,0.2); border-radius:10px; padding:6px 10px; margin-left:6px; font-weight:700; }
  .top-controls button:active{ transform:scale(.96); }

  /* Stats */
  .stats{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; padding:6px; }
  .stats>div{ background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
              border:1px solid rgba(255,255,255,0.12); border-radius:12px; padding:8px 10px; box-shadow:var(--shadow); }
  .stats label{ display:block; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; }
  .stats span{ font-size:18px; font-weight:800; }

  /* Board */
  #board{ position:relative; flex:1; min-height: 60vh; border-radius:16px; border:1px solid rgba(255,255,255,0.1);
          background: radial-gradient(60% 60% at 50% 50%, rgba(68,240,255,.06), transparent 60%),
                      radial-gradient(30% 30% at 50% 50%, rgba(255,216,107,.1), transparent 60%),
                      linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.12));
          box-shadow: var(--shadow); overflow:hidden; }

  /* Ring surface */
  #ring{ position:absolute; inset:0; }
  .ringCircle{ position:absolute; left:50%; top:50%; width: min(82vmin, 600px); height: min(82vmin, 600px);
               transform: translate(-50%, -50%); border-radius:50%; border: 8px solid var(--ring); }

  /* Gate (top) */
  #gate{ position:absolute; left:50%; top:10px; width: 0; height: calc(50% - 10px); pointer-events:none; }
  #gate .tick{ position:absolute; left:-2px; top:0; width:4px; height:22px; background: var(--gold); border-radius:3px;
               box-shadow: var(--gateGlow); }
  #gate:after{ content:""; position:absolute; left:-12px; top:18px; width:24px; height:6px; background:linear-gradient(90deg, transparent, var(--gold), transparent);
               border-radius: 3px; opacity:.85; filter: blur(.5px); }

  /* Center info */
  #center{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); text-align:center; }
  .centerDisc{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
               width: min(44vmin, 340px); height:min(44vmin, 340px); border-radius:50%;
               background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.15));
               border: 1px solid rgba(255,255,255,0.18); box-shadow: var(--shadow); }
  .targetText{ position:relative; z-index:2; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; margin-top:8px; }
  .targetValue{ font-size: clamp(40px, 8.5vmin, 72px); font-weight:900; letter-spacing:1px; text-shadow: 0 3px 18px rgba(0,0,0,.35); }
  .sumText{ position:relative; z-index:2; margin-top:4px; font-size:13px; color:var(--muted); }
  .sumValue{ font-size: clamp(24px, 6.5vmin, 42px); font-weight:800; }

  /* Tiles */
  .tile{ position:absolute; width: clamp(42px, 12.5vmin, 64px); height: clamp(42px, 12.5vmin, 64px);
         background: radial-gradient(160% 140% at 30% 30%, rgba(255,255,255,0.22), rgba(255,255,255,0.05)),
                     linear-gradient(180deg, var(--tile), rgba(0,0,0,0.25));
         border:1px solid var(--tileEdge); border-radius:14px; display:flex; align-items:center; justify-content:center;
         font-weight:900; font-size: clamp(20px, 6vmin, 30px); color:#eaf6ff; box-shadow: var(--glow), var(--shadow); }
  .tile.pop{ animation: pop .28s ease-out; }
  @keyframes pop{ 0%{ transform: scale(1); } 50%{ transform: scale(1.16); } 100%{ transform: scale(1);} }

  /* Controls */
  #controls{ display:grid; grid-template-columns: 1fr auto 1fr; gap:8px; padding:8px; }
  #controls button{ padding:14px 12px; border-radius:12px; font-weight:800; font-size:16px;
                    border:1px solid rgba(255,255,255,0.2); background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.15));
                    color:var(--fg); box-shadow: var(--shadow); }
  #controls button.hold{ font-size:18px; }
  #controls button:active{ transform: translateY(1px) scale(.98); }
  #slowBtn{ border-color: rgba(255,216,107,.45); }
  #slowBtn strong{ color:var(--gold); }

  /* Overlay */
  .overlay{ position: absolute; inset: 0; background: rgba(0,0,0,.55);
            display:none; align-items:center; justify-content:center; backdrop-filter: blur(4px); z-index: 30; }
  .overlay.show{ display:flex; }
  .card{ width:min(560px, 92vw); background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(0,0,0,0.22));
         border:1px solid rgba(255,255,255,0.25); border-radius:16px; padding:18px; box-shadow: var(--shadow); }
  .card h1{ margin:.2em 0 .2em; font-size: clamp(20px, 6.5vmin, 34px); }
  .card p{ color:var(--fg); opacity:.95; }
  .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
  .card button{ padding:12px 14px; border-radius:12px; font-weight:900; border:1px solid rgba(255,255,255,0.2);
                background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(0,0,0,0.25)); color:var(--fg); }
  .small{ font-size:13px; color:var(--muted); }

  /* Feedback */
  .flash{ animation: flash .45s ease-out; }
  @keyframes flash{ 0%{ background: rgba(255,92,122,.0);} 20%{ background: rgba(255,92,122,.25);} 100%{ background: rgba(255,92,122,.0);} }
  .shake{ animation: shake .3s ease-in-out; }
  @keyframes shake{ 0%{ transform:translateX(0);} 25%{ transform:translateX(-6px);} 50%{ transform:translateX(4px);} 75%{ transform:translateX(-3px);} 100%{ transform:translateX(0);} }

  .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:rgba(68,240,255,.12);
          border:1px solid rgba(68,240,255,.35); color:var(--accent); font-weight:800; font-size:12px; text-transform:uppercase; letter-spacing:.4px; }

  .noselect, #controls button, .top-controls button, .tile { user-select:none; -webkit-user-select:none; }
</style>
</head>
<body>
<div id="app">

  <header class="topbar">
    <div class="brand">ORBIT SUM</div>
    <div class="top-controls">
      <button id="helpBtn" aria-label="How to play">‚ùî Help</button>
      <button id="muteBtn" aria-label="Toggle sound">üîà Sound</button>
      <button id="pauseBtn" aria-label="Pause">‚è∏ Pause</button>
    </div>
  </header>

  <section class="stats">
    <div><label>Score</label><span id="score">0</span></div>
    <div><label>High</label><span id="high">0</span></div>
    <div><label>Level</label><span id="level">1</span></div>
    <div><label>Lives</label><span id="lives">‚ù§‚ù§‚ù§</span></div>
  </section>

  <main id="board">
    <div id="ring">
      <div class="ringCircle" aria-hidden="true"></div>
      <!-- Tiles injected by JS -->
    </div>

    <div id="gate" aria-hidden="true"><div class="tick"></div></div>

    <div id="center" class="noselect" aria-live="polite">
      <div class="centerDisc" aria-hidden="true"></div>
      <div class="targetText">Target</div>
      <div class="targetValue" id="target">‚Äî</div>
      <div class="sumText">Sum</div>
      <div class="sumValue" id="sum">0</div>
      <div class="small" id="notice"></div>
    </div>
  </main>

  <section id="controls">
    <button id="leftBtn" class="hold" aria-label="Hold to spin left">‚óÄÔ∏é Spin</button>
    <button id="slowBtn" class="hold" aria-label="Hold to slow rotation"><strong>Slow</strong></button>
    <button id="rightBtn" class="hold" aria-label="Hold to spin right">Spin ‚ñ∂Ô∏é</button>
  </section>

  <!-- Overlays -->
  <div id="startOverlay" class="overlay show" role="dialog" aria-modal="true">
    <div class="card">
      <div class="badge">New number game</div>
      <h1>ORBIT SUM</h1>
      <p><strong>Spin the ring. Hit the exact target. Don‚Äôt bust.</strong></p>
      <ul>
        <li>Hold <em>Spin</em> buttons to rotate the ring.</li>
        <li>Every tile crossing the <strong>top gate</strong> is added to your <strong>SUM</strong>.</li>
        <li>Match the <strong>TARGET</strong> exactly to level up and score.</li>
        <li>Overshoot? You lose a life and SUM resets.</li>
        <li><strong>Hold Slow</strong> to steady your timing (no charges).</li>
      </ul>
      <div class="btnRow">
        <button id="startBtn">‚ñ∂ Start</button>
        <button id="howBtn">How to play</button>
      </div>
      <p class="small" style="margin-top:10px;">Designed for iPhone. One file. GitHub Pages‚Äìready. Saves highscores locally.</p>
    </div>
  </div>

  <div id="helpOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card">
      <h1>How to Play</h1>
      <ol>
        <li>Hold left/right <strong>Spin</strong> to rotate the ring.</li>
        <li>As tiles pass the <strong>top gate</strong>, their number is added to <strong>SUM</strong>.</li>
        <li>Reach the <strong>TARGET</strong> exactly. You‚Äôll level up, score a bonus, and the ring gets trickier.</li>
        <li><strong>Overshoot</strong> the target and you lose a life. SUM resets to 0.</li>
        <li><strong>Hold Slow</strong> to significantly reduce rotation speed while pressed.</li>
        <li>Every couple of levels: the ring adds more tiles and spins a bit faster.</li>
      </ol>
      <p class="small">Tip: feather the spin‚Äîshort holds nudge the ring; longer holds whip it. Use <em>Slow</em> near the finish to thread the gate.</p>
      <div class="btnRow">
        <button id="closeHelpBtn">Close</button>
      </div>
    </div>
  </div>

  <div id="pauseOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card">
      <h1>Paused</h1>
      <div class="btnRow">
        <button id="resumeBtn">Resume</button>
        <button id="restartBtn">Restart</button>
      </div>
    </div>
  </div>

  <div id="gameOverOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card">
      <h1>Game Over</h1>
      <p>Score: <strong id="finalScore">0</strong> ¬∑ Level: <strong id="finalLevel">1</strong></p>
      <div class="btnRow">
        <button id="againBtn">Play Again</button>
        <button id="shareBtn">Share</button>
      </div>
      <p class="small">High score is saved on this device.</p>
    </div>
  </div>

</div>

<script>
(() => {
  'use strict';

  /* ---------------------------
     Game configuration (easy-start)
     Tweak these to taste.
  ---------------------------- */
  const START_TILES = 6;           // fewer tiles at level 1
  const MAX_TILES = 14;            // cap to keep things readable
  const LEVELS_PER_TILE = 2;       // add one tile every 2 levels

  const MIN_VAL = 1, MAX_VAL = 9;
  const START_LIVES = 3;

  const BASE_OMEGA_START = 18;     // deg/sec (auto rotation at level 1) ‚Äî slower start
  const HOLD_OMEGA = 95;           // deg/sec added while holding spin
  const DIFFICULTY_PER_LEVEL = 1.09; // base auto speed growth per level (was 1.06)

  const SLOW_FACTOR = 0.38;        // multiply speed while Slow is held (e.g., 38% of normal)

  const TARGET_MIN_START = 8, TARGET_MAX_START = 18; // slightly smaller targets at low levels
  const GATE_HALF_DEG_START = 10.5; // wider gate at start (total ~21¬∞)
  const GATE_HALF_DEG_MIN = 3.5;    // minimum as difficulty grows
  const GATE_SHRINK_PER_LEVEL = 0.35; // degrees per level

  /* ---------------------------
     DOM references
  ---------------------------- */
  const el = {
    board: document.getElementById('board'),
    ring: document.getElementById('ring'),
    gate: document.getElementById('gate'),
    score: document.getElementById('score'),
    high: document.getElementById('high'),
    level: document.getElementById('level'),
    lives: document.getElementById('lives'),
    target: document.getElementById('target'),
    sum: document.getElementById('sum'),
    notice: document.getElementById('notice'),
    leftBtn: document.getElementById('leftBtn'),
    rightBtn: document.getElementById('rightBtn'),
    slowBtn: document.getElementById('slowBtn'),
    muteBtn: document.getElementById('muteBtn'),
    pauseBtn: document.getElementById('pauseBtn'),
    helpBtn: document.getElementById('helpBtn'),
    startOverlay: document.getElementById('startOverlay'),
    helpOverlay: document.getElementById('helpOverlay'),
    pauseOverlay: document.getElementById('pauseOverlay'),
    gameOverOverlay: document.getElementById('gameOverOverlay'),
    startBtn: document.getElementById('startBtn'),
    howBtn: document.getElementById('howBtn'),
    closeHelpBtn: document.getElementById('closeHelpBtn'),
    resumeBtn: document.getElementById('resumeBtn'),
    restartBtn: document.getElementById('restartBtn'),
    againBtn: document.getElementById('againBtn'),
    shareBtn: document.getElementById('shareBtn'),
    finalScore: document.getElementById('finalScore'),
    finalLevel: document.getElementById('finalLevel'),
  };

  /* ---------------------------
     State
  ---------------------------- */
  let tileCount = START_TILES;
  let tiles = []; // {el, baseDeg, wasInGate, val}
  let w = 0, h = 0, cx = 0, cy = 0, radius = 0;
  let theta = 0;                // ring rotation in degrees
  let omegaBase = BASE_OMEGA_START; // auto angular speed
  let holdLeft = false, holdRight = false, holdSlow = false;
  let lastTime = performance.now();
  let running = false, paused = false, gameOver = false;
  let level = 1, score = 0, high = +localStorage.getItem('orbitsum_high')||0;
  let lives = START_LIVES;
  let target = 0, sum = 0;
  let gateHalfDeg = GATE_HALF_DEG_START;
  let muted = false;
  let audioCtx = null;

  el.high.textContent = String(high);

  /* ---------------------------
     Utilities
  ---------------------------- */
  const randInt = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
  const clamp   = (x,a,b)=> Math.max(a, Math.min(b,x));
  const now     = ()=> performance.now();
  const normDeg = (d)=> { d = d%360; if(d>180) d-=360; if(d<=-180) d+=360; return d; };

  function chooseValue(){ return randInt(MIN_VAL, MAX_VAL); }

  function vibrate(pattern){ try{ if(!muted && navigator.vibrate) navigator.vibrate(pattern); }catch{} }

  function ensureAudio(){
    if(muted) return;
    if(!audioCtx){
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(Ctx) audioCtx = new Ctx();
    }
  }

  function beep(freq=520, ms=80, type='sine', vol=0.05){
    if(muted || !audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + ms/1000);
  }

  function setNotice(msg='', color=''){
    el.notice.textContent = msg;
    el.notice.style.color = color || 'inherit';
    if(msg){
      el.notice.classList.remove('flash');
      void el.notice.offsetWidth;
      el.notice.classList.add('flash');
    }
  }

  function setHearts(n){
    el.lives.textContent = '‚ù§'.repeat(n);
    el.lives.style.color = n<=1 ? 'var(--danger)' : 'inherit';
  }

  function newTarget(baseMin = TARGET_MIN_START, baseMax = TARGET_MAX_START){
    const L = clamp(level, 1, 50);
    const min = baseMin + Math.floor(L*0.2);
    const max = baseMax + Math.floor(L*0.4);
    target = randInt(min, max);
    el.target.textContent = String(target);
    setNotice('New target!', 'var(--accent2)');
  }

  /* ---------------------------
     Layout & tiles
  ---------------------------- */
  function layout(){
    const rect = el.board.getBoundingClientRect();
    w = rect.width; h = rect.height;
    cx = w/2; cy = h/2;
    radius = Math.min(w,h) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--radiusRatio'));
    positionTiles();
  }

  function createTiles(){
    tiles = [];
    el.ring.querySelectorAll('.tile').forEach(n=>n.remove());
    for(let i=0;i<tileCount;i++){
      const t = document.createElement('div');
      t.className = 'tile';
      const baseDeg = i*(360/tileCount);
      const val = chooseValue();
      t.textContent = val;
      el.ring.appendChild(t);
      tiles.push({ el:t, baseDeg, wasInGate:false, val });
    }
    positionTiles();
  }

  function positionTiles(){
    for(const t of tiles){
      const deg = (t.baseDeg + theta) % 360;
      const rad = deg * Math.PI/180;
      const x = cx + radius * Math.sin(rad);
      const y = cy - radius * Math.cos(rad);
      t.el.style.left = (x - t.el.offsetWidth/2) + 'px';
      t.el.style.top  = (y - t.el.offsetHeight/2) + 'px';
    }
  }

  /* ---------------------------
     Core game loop
  ---------------------------- */
  function update(){
    if(!running || paused) { lastTime = now(); requestAnimationFrame(update); return; }
    const t = now();
    const dt = Math.min(0.035, (t - lastTime)/1000); // clamp big jumps
    lastTime = t;

    // Effective speed
    let omega = omegaBase;
    if(holdLeft)  omega -= HOLD_OMEGA;
    if(holdRight) omega += HOLD_OMEGA;

    // Slow while holding the center button
    if(holdSlow) omega *= SLOW_FACTOR;

    omega = clamp(omega, -240, 240);
    theta = (theta + omega * dt) % 360;

    // Gate detection + render
    let justCollected = false;
    for(const tile of tiles){
      const deg = (tile.baseDeg + theta) % 360;
      const d = Math.abs(normDeg(deg));  // gate is at 0¬∞
      if(d <= gateHalfDeg){
        if(!tile.wasInGate){
          collect(tile);
          tile.wasInGate = true;
          justCollected = true;
        }
      }else{
        tile.wasInGate = false;
      }
    }

    positionTiles();

    if(justCollected){
      el.board.classList.remove('flash');
      void el.board.offsetWidth;
      el.board.classList.add('flash');
    }

    requestAnimationFrame(update);
  }

  function collect(tile){
    // feedback
    tile.el.classList.remove('pop'); void tile.el.offsetWidth; tile.el.classList.add('pop');
    ensureAudio();
    beep(440 + tile.val*24, 70, 'triangle', 0.035);
    vibrate(18);

    sum += tile.val;
    el.sum.textContent = String(sum);

    // Re-roll the tile value immediately (stays at same place)
    tile.val = chooseValue();
    tile.el.textContent = tile.val;

    // Check win/bust
    if(sum === target){
      onHitTarget();
    }else if(sum > target){
      onBust();
    }
  }

  function onHitTarget(){
    score += 100 + Math.floor(level*35);
    level += 1;

    // Difficulty rise
    omegaBase = BASE_OMEGA_START * Math.pow(DIFFICULTY_PER_LEVEL, level-1);
    gateHalfDeg = Math.max(GATE_HALF_DEG_MIN, GATE_HALF_DEG_START - (level-1)*GATE_SHRINK_PER_LEVEL);

    // Add tiles gradually
    const desiredTiles = Math.min(MAX_TILES, START_TILES + Math.floor((level-1)/LEVELS_PER_TILE));
    if(desiredTiles !== tileCount){
      tileCount = desiredTiles;
      createTiles(); // rebuild ring with more tiles
    }

    // reset sum & new target
    sum = 0;
    el.sum.textContent = '0';
    newTarget();

    // UI feedback
    setNotice('Perfect!', 'var(--accent)');
    el.board.classList.add('shake'); setTimeout(()=>el.board.classList.remove('shake'), 180);
    ensureAudio(); beep(720, 110, 'square', 0.06); beep(860, 130, 'sine', 0.05);
    vibrate([25,30,25]);

    updateUI();
  }

  function onBust(){
    lives -= 1;
    sum = 0;
    el.sum.textContent = '0';
    setHearts(lives);
    setNotice('Bust!', 'var(--danger)');
    ensureAudio(); beep(180, 120, 'sawtooth', 0.05);
    vibrate([60,40,60]);
    if(lives <= 0){ endGame(); }
  }

  function updateUI(){
    el.score.textContent = String(score);
    el.level.textContent = String(level);
    if(score > high){
      high = score;
      el.high.textContent = String(high);
      localStorage.setItem('orbitsum_high', String(high));
    }
  }

  /* ---------------------------
     Lifecycle
  ---------------------------- */
  function startGame(){
    running = true; paused = false; gameOver = false;
    level = 1; score = 0; lives = START_LIVES; sum = 0;
    tileCount = START_TILES;
    omegaBase = BASE_OMEGA_START;
    gateHalfDeg = GATE_HALF_DEG_START;
    setHearts(lives);
    el.sum.textContent = '0'; el.notice.textContent = '';
    newTarget();
    createTiles();
    layout();
    lastTime = now();
    requestAnimationFrame(update);
  }

  function endGame(){
    running = false; gameOver = true;
    el.finalScore.textContent = String(score);
    el.finalLevel.textContent = String(level);
    el.gameOverOverlay.classList.add('show');
  }

  function pauseGame(){
    if(!running || gameOver) return;
    paused = true;
    el.pauseOverlay.classList.add('show');
  }

  function resumeGame(){
    if(!running || gameOver) return;
    paused = false;
    el.pauseOverlay.classList.remove('show');
    lastTime = now();
  }

  /* ---------------------------
     Controls & events
  ---------------------------- */
  function holdStart(dir){
    if(dir<0) holdLeft = true; else holdRight = true;
  }
  function holdEnd(dir){
    if(dir<0) holdLeft = false; else holdRight = false;
  }

  function addHoldHandlers(btn, dir){
    btn.addEventListener('pointerdown', ()=>holdStart(dir));
    const end = ()=>holdEnd(dir);
    btn.addEventListener('pointerup', end);
    btn.addEventListener('pointercancel', end);
    btn.addEventListener('pointerleave', end);
  }
  addHoldHandlers(el.leftBtn, -1);
  addHoldHandlers(el.rightBtn, +1);

  // Slow: hold to reduce speed
  el.slowBtn.addEventListener('pointerdown', ()=>{
    holdSlow = true;
    setNotice('Slow', 'var(--gold)');
    vibrate(16);
  });
  const endSlow = ()=>{ holdSlow = false; el.notice.textContent = ''; };
  el.slowBtn.addEventListener('pointerup', endSlow);
  el.slowBtn.addEventListener('pointercancel', endSlow);
  el.slowBtn.addEventListener('pointerleave', endSlow);

  el.muteBtn.addEventListener('click', ()=>{
    muted = !muted;
    el.muteBtn.textContent = (muted ? 'üîá Muted' : 'üîà Sound');
    if(!muted) ensureAudio();
  });

  el.pauseBtn.addEventListener('click', ()=> pauseGame());
  el.resumeBtn.addEventListener('click', ()=> resumeGame());
  el.restartBtn.addEventListener('click', ()=>{
    el.pauseOverlay.classList.remove('show');
    startGame();
  });

  // Help / overlays
  el.helpBtn.addEventListener('click', ()=> el.helpOverlay.classList.add('show'));
  el.closeHelpBtn.addEventListener('click', ()=> el.helpOverlay.classList.remove('show'));
  el.howBtn.addEventListener('click', ()=>{
    el.startOverlay.classList.remove('show');
    el.helpOverlay.classList.add('show');
  });

  el.startBtn && el.startBtn.addEventListener('click', ()=>{
    el.startOverlay.classList.remove('show');
    ensureAudio(); // unlock audio on first user gesture
    startGame();
  });

  el.againBtn.addEventListener('click', ()=>{
    el.gameOverOverlay.classList.remove('show');
    startGame();
  });

  el.shareBtn.addEventListener('click', async ()=>{
    const text = `I scored ${score} on ORBIT SUM (Level ${level})!`;
    try{
      if(navigator.share){
        await navigator.share({ text, title:'ORBIT SUM' });
      }else{
        await navigator.clipboard.writeText(text);
        setNotice('Copied to clipboard!', 'var(--accent2)');
      }
    }catch{}
  });

  // Resize
  window.addEventListener('resize', layout);
  window.addEventListener('orientationchange', ()=> { setTimeout(layout, 200); });

  // Keyboard (optional on desktop)
  window.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowLeft') holdStart(-1);
    if(e.key==='ArrowRight') holdStart(+1);
    if(e.key.toLowerCase()==='s'){ holdSlow = true; setNotice('Slow', 'var(--gold)'); }
    if(e.key==='Escape') pauseGame();
  });
  window.addEventListener('keyup', (e)=>{
    if(e.key==='ArrowLeft') holdEnd(-1);
    if(e.key==='ArrowRight') holdEnd(+1);
    if(e.key.toLowerCase()==='s'){ holdSlow = false; el.notice.textContent = ''; }
  });

  // Initial layout
  layout();

  /* ---------------------------
     End of IIFE
  ---------------------------- */
})();
</script>
</body>
</html>
